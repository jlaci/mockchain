<html>
  <head>
    <title>MockChain test client</title>
    <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  </head>
  <body>
    <div class="container">
      <h1>Mined block</h1>
      <button id="startBtn" onclick="startMining()">Start mining</button>
      <button id="stopBtn" onclick="stopMining()">Stop mining</button>
      <pre id="out">
      </pre>
    </div>

    <script>
      var stopped = false;

      // Configuration
      var config = {
        wsUrl: "ws://localhost:8080//block-changed",
        hardness: 4,
        yieldTime: 1000
      };

      var startString = "";
      for (var i = 0; i < config.hardness; i++) {
        startString += "0";
      }
      config.startString = startString;

      //Worker
      var worker = new Worker("miner.js");
      worker.onmessage = function (e) {
        if (e.data === "failed") {
          $('#out').append("failed<br/>");
        } else {
          $('#out').append("Mined block " + e.data.blockId + "(" + e.data.transactions.length + ")<br/>");
          $.ajax({
            type: 'POST',
            url: '/mining/mined-block',
            contentType: 'application/json',
            data: JSON.stringify(e.data)
          }).then(function() {
              //$('#out').append("Sent mined block.<br/>");
          });
        }
      };

      function stopMining() {
        stopped = true;
        worker.postMessage("stop");
        $('#out').append("Stopped mining.<br/>");
        $('#startBtn').prop('disabled', false);
        $('#endBtn').prop('disabled', true);
      }

      function startMining() {
        stopped = false;
        $('#startBtn').prop('disabled', true);
        $('#endBtn').prop('disabled', false);

        $('#out').append("Started mining, waiting for block.<br/>");
        var ws = new WebSocket(config.wsUrl);
        ws.onmessage = function (data) {
          if (stopped === false) {
            var block = JSON.parse(data.data);
            var param = {
              block: block,
              config: config
            };
            $('#out').append('Mining block: ' + block.blockId + '(' + block.transactions.length + ')<br/>');
            worker.postMessage(param);
            mining = true;
          }
        };
      }
    </script>
  </body>
</html>
