<html>
  <head>
    <title>MockChain test client</title>
    <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  </head>
  <body>
    <div class="container">
      <h1>Mined block</h1>
      <button onclick="startMining()">Start mining</button>
      <button onclick="stopMining()">Stop mining</button>
      <pre id="out">
      </pre>
    </div>

    <script>
      // Configuration
      var config = {
        wsUrl: "ws://localhost:8080//block-changed",
        maxTries: 10000000,
        hardness: 4
      };

      var startString = "";
      for (var i = 0; i < config.hardness; i++) {
        startString += "0";
      }
      config.startString = startString;


      //Worker
      var worker = new Worker("miner.js");
      worker.onmessage = function (e) {
        if (e.data !== "failed") {
          $('#out').html(JSON.stringify(e.data, null, 4));
          $.ajax({
            type: 'POST',
            url: '/mining/mined-block',
            dataType: 'application/json',
            data: JSON.stringify(e.data)
          }).then(function() {

          });
        } else {
          $('#out').html("failed");
        }
      };

      function stopMining() {
        worker.postMessage("stop");
        $('#out').html("Stopped mining");
      }

      function startMining() {
        $('#out').html("Started mining, waiting for block...");
        var ws = new WebSocket(config.wsUrl);
        ws.onmessage = function(data){
          var param = {
            block: data.data,
            config: config
          };
          $('#out').html("Mining block: " + JSON.stringify(JSON.parse(data.data), null, 4));
          worker.postMessage(param);
        };
      }
    </script>
  </body>
</html>
